define(["core/str","filter_teamwork/ajax","filter_teamwork/popup","filter_teamwork/render","filter_teamwork/dragula","filter_teamwork/skin"],function(e,t,a,s,r,d){const n=document.querySelector("body"),o=(e,a,s,r)=>{t.data={method:"set_teamwork_enable",courseid:e,activityid:a,moduletype:s},t.run()},i=(e,a,s,r)=>{const d=r.checked;t.data={method:"set_access_to_student",access:d,courseid:e,activityid:a,moduletype:s},t.send()},u=(e,a,s,r,d)=>{t.data={method:"add_new_card",courseid:e,activityid:a,moduletype:s,selectgroupid:r},t.run(d)},l=(e,a,s,r,d)=>{t.data={method:"delete_card",courseid:a,activityid:s,moduletype:r,teamid:e},t.run(d)},c=(e,a)=>{t.data={method:"render_student_settings_popup",activityid:e,moduletype:a},t.runPopup(),setTimeout(m,1e3)},m=()=>{const e=document.querySelector("#teamuserallowenddate"),t=Array.from(document.querySelectorAll(".teamuserenddate-inputs-wrapper input, .teamuserenddate-inputs-wrapper select"));e.addEventListener("change",e=>{e.target.checked?(t.forEach(e=>{e.removeAttribute("disabled")}),e.target.value="1"):(t.forEach(e=>{e.setAttribute("disabled","disabled")}),e.target.value="0")})},p=(e,a,s)=>{const r=document.querySelector(".teamwork-modal"),d=r.querySelector("#teamnumbers").value,n=r.querySelector("#teamusernumbers").value,o=r.querySelector("input[name=team-userend-date]").value,i=r.querySelector("select[name=team-userend-month]").value,u=r.querySelector("input[name=team-userend-year]").value,l=r.querySelector("input[name=team-userend-hour]").value,c=r.querySelector("input[name=team-userend-minute]").value,m=r.querySelector("input[name=teamuserallowenddate]").value;t.data={method:"student_settings_popup_data",teamNumbers:d,teamUserNumbers:n,teamUserendDate:o,teamUserendMonth:i,teamUserendYear:u,teamUserendHour:l,teamUserenMinute:c,teamuserallowenddate:m,courseid:e,activityid:a,moduletype:s},t.send()},v=(e,a,s,r,d,n)=>{for(;!e.classList.contains("teamwork-modal");)e=e.parentNode;const o=e.querySelector("#student_number").value;t.data={method:"set_random_team",numberOfStudent:o,courseid:a,activityid:s,moduletype:r,selectgroupid:d},t.run(n)},_=(e,a)=>{const s=e.value;t.data={method:"set_number_of_student_each_team",numberOfStudent:s},t.run(a)},h=()=>{const e=n.querySelector('input[data-handler = "search_student"]');e.addEventListener("input",function(t){(e=>{const t=Array.from(document.querySelectorAll("#studentList div[data-student_id]")),a=e.value;if(!a)return void t.forEach(e=>{e.classList.remove("visuallyhidden")});let s=new RegExp(`${a}`,"i");t.forEach(e=>{e.innerHTML.search(s)>=0?e.classList.remove("visuallyhidden"):e.classList.add("visuallyhidden")})})(e)})},f=e=>{const t=Array.from(document.querySelectorAll("#studentList div[data-student_id]"));n.querySelector('input[data-handler = "search_student"]').value="",t.forEach(e=>{e.classList.remove("visuallyhidden")})};return{init:function(e,m,y,g){s.data={sesskey:M.cfg.sesskey,courseid:e,activityid:m,moduletype:y,selectgroupid:g},$("#open_filter").on("click",function(){s.mainBlock(h)}),document.addEventListener("click",function(r){let h=r.target;for(;h!==n;){if("teamwork_toggle"===h.dataset.handler)return h.classList.toggle("active"),$(".skin_shadow").toggleClass("skin_show"),$(".skin_shadow").toggleClass("skin_hide"),void o(e,m,y);if(h.classList.contains("close_popup")||h.classList.contains("teamwork-modal_close")){if(h.classList.contains("stop-close"))return;return void a.remove()}if(h.classList.contains("skin_close"))return void d.remove();if("access_to_student"===h.dataset.handler&&(h.classList.contains("active")?(h.classList.remove("active"),i(e,m,y,h)):(h.classList.add("active"),c(m,y),i(e,m,y,h))),"get_popup_data"===h.dataset.handler)return r.preventDefault(),p(e,m,y),void a.remove();if("open_group_selection"===h.dataset.handler)return void $(h).next().slideToggle();if("select_groups"===h.dataset.handler){let e=document.querySelector('html[lang="en"]')?"choose grous":"בחר קבוצה";if(h.classList.contains("selected"))return;h.classList.toggle("selected"),$('div[data-handler="open_group_selection"]').html(h.classList.contains("selected")?h.innerHTML:e),$(h).siblings().removeClass("selected");let t=[];return Array.from(h.parentNode.children).forEach(e=>{e.classList.contains("selected")&&t.push(e.dataset.value)}),$(h).parent().slideToggle(),g=JSON.stringify(t),s.data.selectgroupid=JSON.stringify(t),s.studentList(),void s.teamsCard()}if("add_new_teamcard"===h.dataset.handler)return void u(e,m,y,g,function(){s.setDefaultData(),s.studentList(),s.teamsCard()});if("delete_teamcard"===h.dataset.handler){let t=h.dataset.remove_team_id;return void l(t,e,m,y,function(){s.setDefaultData(),s.teamsCard(),s.studentList()})}if("random_popup"===h.dataset.handler)return t.data={method:"show_random_popup"},void t.runPopup();if("random"===h.dataset.handler)return void v(h,e,m,y,s.data.selectgroupid,function(){s.teamsCard(),s.studentList()});if("team_size"===h.dataset.handler)return void _(h,function(){s.data={sesskey:M.cfg.sesskey},s.teamsCard()});if("search_reset"===h.dataset.handler)return void f();h=h.parentNode}}),r.startDrag(),document.addEventListener("change",function(e){"input_team_name"===e.target.dataset.handler&&(e=>{const a=e.dataset.team_id,s=e.value;t.data={method:"set_new_team_name",cardid:a,cardname:s},t.send()})(e.target)}),document.addEventListener("keydown",function(e){27===e.keyCode&&(d.remove(),a.remove())})}}});